app-id: io.github.mall0r.Twinverse
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: twinverse

finish-args:
  # GPU acceleration
  - --device=dri
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # Input devices (evdev)
  - --device=all

  # For start instances, isolate devices and KDE integration
  # This app requires access to flatpak-spawn to create sandboxed instances, move gamescope windows and isolate devices between instances
  - --talk-name=org.freedesktop.Flatpak

  # KDE D-Bus integration
  - --talk-name=org.freedesktop.DBus
  - --talk-name=org.kde.KWin
  - --talk-name=org.kde.plasmashell
  - --system-talk-name=org.freedesktop.login1

  # File system access
  - --filesystem=~/.local/share/Steam/steamapps:ro
  - --filesystem=~/.local/share/Steam/compatibilitytools.d:ro
  - --filesystem=/tmp

modules:
  # Python dependencies - generated by flatpak-pip-generator
  - flatpak/python-modules.json

  # Main application
  - name: twinverse
    buildsystem: simple
    build-commands:
      # Copy source files
      - mkdir -p /app/lib/twinverse
      - cp -r src /app/lib/twinverse/
      - cp -r res /app/lib/twinverse/
      - cp twinverse.py /app/lib/twinverse/

      # Create bin directory and wrapper script
      - mkdir -p /app/bin
      - |
        cat > /app/bin/twinverse << 'WRAPPER_EOF'
        #!/bin/bash
        exec python3 /app/lib/twinverse/twinverse.py "$@"
        WRAPPER_EOF
      - chmod +x /app/bin/twinverse

      # Install desktop file and icon
      - install -Dm644 share/applications/io.github.mall0r.Twinverse.desktop /app/share/applications/io.github.mall0r.Twinverse.desktop
      - install -Dm644 share/icons/hicolor/scalable/apps/io.github.mall0r.Twinverse.svg /app/share/icons/hicolor/scalable/apps/io.github.mall0r.Twinverse.svg

      # Update desktop file with correct app-id
      - desktop-file-edit --set-key=Icon --set-value=io.github.mall0r.Twinverse /app/share/applications/io.github.mall0r.Twinverse.desktop
      - desktop-file-edit --set-key=Exec --set-value=twinverse /app/share/applications/io.github.mall0r.Twinverse.desktop

      # Install metainfo
      - install -Dm644 share/metainfo/io.github.mall0r.Twinverse.metainfo.xml /app/share/metainfo/io.github.mall0r.Twinverse.metainfo.xml

    sources:
      - type: dir
        path: .

    cleanup:
      - "*.a"
      - "*.la"
      - "/man"
      - "/include"
      - "/lib/pkgconfig"
      - "/share/aclocal"
      - "/share/man"
      - "/share/doc"
      - "/share/info"
      - "/share/gtk-doc"
      - "/libexec"
