name: Flatpak Release Pipeline

on:
  push:
    branches: [main, master, build/workflow]
  workflow_dispatch:
    inputs:
      version:
        description: 'Versão específica (ex: v1.2.3)'
        required: true
        default: 'v0.0.0'

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # Fase 1: Análise estática e linting
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libgirepository-2.0-dev \
            make \
            gcc \
            libcairo2-dev \
            pkg-config \
            python3-dev \
            libglib2.0-dev \
            libxml2-dev \
            libxslt1-dev \
            libgtk-4-dev \
            libadwaita-1-dev \
            gir1.2-gtk-4.0 \
            gir1.2-adw-1 \
            libglib2.0-dev-bin

      - name: Install dependencies
        run: |
          pip install pre-commit
          pre-commit install
          pip install .[test]

      - name: Run static analysis
        run: pre-commit run --all-files

  # Fase 2: Versionamento semântico automático
  semantic:
    needs: analyze
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.new_release_version || '1.0.0' }}
      changelog: ${{ steps.release.outputs.new_release_notes || 'Initial release' }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install and run semantic-release
        id: release
        uses: cycjimmy/semantic-release-action@v6
        with:
          semantic_version: 25
          extra_plugins: '@semantic-release/github @semantic-release/git @semantic-release/exec conventional-changelog-conventionalcommits'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Fase 3: Build apenas para x86_64
  build:
    needs: [analyze, semantic]
    runs-on: ubuntu-latest
    outputs:
      artifact_name: flatpak-${{ needs.semantic.outputs.version }}-x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set artifact name
        id: set_artifact_name
        run: |
          VERSION="${{ needs.semantic.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak \
          flatpak-builder \
          libgirepository1.0-dev \
          libgirepository-2.0-dev \
          make \
          gcc \
          libcairo2-dev \
          pkg-config \
          python3-dev \
          libglib2.0-dev \
          libxml2-dev \
          libxslt1-dev \
          libgtk-4-dev \
          libadwaita-1-dev \
          gir1.2-gtk-4.0 \
          gir1.2-adw-1 \
          libglib2.0-dev-bin
          pip install pytest pytest-cov

      - name: Add Flathub repository
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install SDK and Platform
        run: |
          flatpak install -y --user flathub org.gnome.Platform//49 org.gnome.Sdk//49

      - name: Build Flatpak
        run: make flatpak
        env:
          FLATPAK_ARCH: x86_64

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: flatpak-${{ needs.semantic.outputs.version }}-x86_64
          path: |
            build-dir/*.flatpak
            build-dir/*.json

  # Fase 4: Criar release no GitHub
  create-release:
    needs: [semantic, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: dist/x86_64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.semantic.outputs.version }}
          name: Release v${{ needs.semantic.outputs.version }}
          body: ${{ needs.semantic.outputs.changelog }}
          files: |
            dist/x86_64/*.flatpak
            dist/x86_64/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Fase 5: Publicar no Flathub (requer permissão)
  publish-flathub:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Flatpak Builder
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: io.github.mall0r.Twinverse.yaml

      - name: Submit to Flathub
        env:
          FLATHUB_TOKEN: ${{ secrets.FLATHUB_TOKEN }}
        run: |
          # Este passo requer configuração prévia no Flathub
