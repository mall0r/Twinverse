app-id: io.github.mallor.MultiScope
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: multiscope

finish-args:
  # GPU acceleration
  - --device=dri
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # Input devices (evdev)
  - --device=all

  # DBus for KDE integration
  - --socket=session-bus
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.kde.KWin
  - --talk-name=org.kde.plasmashell

  # Network (if needed)
  - --share=network

  # File system access
  - --filesystem=home
  - --filesystem=/tmp

  # PulseAudio/Pipewire
  - --socket=pulseaudio

modules:
  # Add pulseaudio-utils to make `pactl` available
  - name: pulseaudio-utils
    buildsystem: simple
    build-commands:
      - "install -d /app/bin"
      - "install /usr/bin/pactl /app/bin/"

  # Python dependencies - generated by flatpak-pip-generator
  - flatpak/python-modules.json

  # Main application
  - name: multiscope
    buildsystem: simple
    build-commands:
      # Copy source files
      - mkdir -p /app/lib/multiscope
      - cp -r src /app/lib/multiscope/
      - cp -r scripts /app/lib/multiscope/
      - cp -r res /app/lib/multiscope/
      - cp multiscope.py /app/lib/multiscope/

      # Create bin directory and wrapper script
      - mkdir -p /app/bin
      - |
        cat > /app/bin/multiscope << 'WRAPPER_EOF'
        #!/bin/bash
        exec python3 /app/lib/multiscope/multiscope.py "$@"
        WRAPPER_EOF
      - chmod +x /app/bin/multiscope

      # Install desktop file and icon
      - install -Dm644 share/applications/io.github.mallor.MultiScope.desktop /app/share/applications/io.github.mallor.MultiScope.desktop
      - install -Dm644 share/icons/hicolor/scalable/apps/io.github.mallor.MultiScope.svg /app/share/icons/hicolor/scalable/apps/io.github.mallor.MultiScope.svg

      # Update desktop file with correct app-id
      - desktop-file-edit --set-key=Icon --set-value=io.github.mallor.MultiScope /app/share/applications/io.github.mallor.MultiScope.desktop
      - desktop-file-edit --set-key=Exec --set-value=multiscope /app/share/applications/io.github.mallor.MultiScope.desktop

      # Install metainfo
      - install -Dm644 share/metainfo/io.github.mallor.MultiScope.metainfo.xml /app/share/metainfo/io.github.mallor.MultiScope.metainfo.xml

    sources:
      - type: dir
        path: .
